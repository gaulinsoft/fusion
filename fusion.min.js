/*! ------------------------------------------------------------------------
//                                   Fusion
//  ------------------------------------------------------------------------
//
//                       Copyright 2014 Nicholas Gaulin
//
//       Licensed under the Apache License, Version 2.0 (the "License");
//      you may not use this file except in compliance with the License.
//                   You may obtain a copy of the License at
//
//                 http://www.apache.org/licenses/LICENSE-2.0
//
//     Unless required by applicable law or agreed to in writing, software
//      distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//     See the License for the specific language governing permissions and
//                       limitations under the License.
*/
(function(E,fa){E||(E={});var A=Object,G=A.create,Q=A.defineProperty,H=A.freeze,V=A.getPrototypeOf,n=A.keys,W=A.preventExtensions,X=A.seal,Y=A.prototype.hasOwnProperty,L=Array,A=L.prototype,R=L.isArray,L=Error,Z=parseInt,$=String.prototype;if(!(G&&Q&&H&&V&&W&&X&&R&&A.forEach&&A.indexOf&&$.trim))throw new L("JavaScript engine does not support ECMAScript 5.");var H="undefined"!=typeof window&&null!=window&&window.window===window?window:{},M={Aacute:"C1",aacute:"E1",Acirc:"C2",acirc:"E2",acute:"B4",
AElig:"C6",aelig:"E6",Agrave:"C0",agrave:"E0",amp:"26",AMP:"26",Aring:"C5",aring:"E5",Atilde:"C3",atilde:"E3",Auml:"C4",auml:"E4",brvbar:"A6",Ccedil:"C7",ccedil:"E7",cedil:"B8",cent:"A2",copy:"A9",COPY:"A9",curren:"A4",deg:"B0",divide:"F7",Eacute:"C9",eacute:"E9",Ecirc:"CA",ecirc:"EA",Egrave:"C8",egrave:"E8",ETH:"D0",eth:"F0",Euml:"CB",euml:"EB",frac12:"BD",frac14:"BC",frac34:"BE",gt:"3E",GT:"3E",Iacute:"CD",iacute:"ED",Icirc:"CE",icirc:"EE",iexcl:"A1",Igrave:"CC",igrave:"EC",iquest:"BF",Iuml:"CF",
iuml:"EF",laquo:"AB",lt:"3C",LT:"3C",macr:"AF",micro:"B5",middot:"B7",nbsp:"A0",not:"AC",Ntilde:"D1",ntilde:"F1",Oacute:"D3",oacute:"F3",Ocirc:"D4",ocirc:"F4",Ograve:"D2",ograve:"F2",ordf:"AA",ordm:"BA",Oslash:"D8",oslash:"F8",Otilde:"D5",otilde:"F5",Ouml:"D6",ouml:"F6",para:"B6",plusmn:"B1",pound:"A3",quot:"22",QUOT:"22",raquo:"BB",reg:"AE",REG:"AE",sect:"A7",shy:"AD",sup1:"B9",sup2:"B2",sup3:"B3",szlig:"DF",THORN:"DE",thorn:"FE",times:"D7",Uacute:"DA",uacute:"FA",Ucirc:"DB",ucirc:"FB",Ugrave:"D9",
ugrave:"F9",uml:"A8",Uuml:"DC",uuml:"FC",Yacute:"DD",yacute:"FD",yen:"A5",yuml:"FF"},aa=/[<>&'"]/g;n(M).forEach(function(b,e,l){M[b+";"]=M[b]});var s=function(b,e,l,k,n,q){Q(b,e,{configurable:!!q,enumerable:!!n,value:l,writable:!!k})},n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";G(null);var n=n+n.toLowerCase(),I=function(b,e,l){if(!e||!b||e.length>b.length)return!1;if(!l||l>b.length)l=b.length;return e==b.substr(l-e.length)},ba=function(b){return"&#"+b.charCodeAt(0)+";"},O=function(b,e,l){for(l||(l=" ");b.length<
e;)b=l+b;return b},x=function(b,e,l){if(!e||!b||e.length>b.length)return!1;if(!l||0>l)l=0;return e==b.substr(l,e.length)},J=function(b){return"a"<=b&&"z">=b||"A"<=b&&"Z">=b||"0"<=b&&"9">=b},ca=function(b){return"0"==b||"1"==b},w=function(b){return"a"<=b&&"f">=b||"A"<=b&&"F">=b||"0"<=b&&"9">=b},y=function(b){return"a"<=b&&"z">=b||"A"<=b&&"Z">=b},B=function(b){return"\r"==b||"\n"==b||"\u2028"==b||"\u2029"==b},u=function(b){return"0"<=b&&"9">=b},da=function(b){return"0"<=b&&"7">=b},z=function(b){return" "==
b||"\r"==b||"\n"==b||"\t"==b||"\f"==b},S=function(b){return"\t"==b||"\v"==b||"\f"==b||" "==b||"\u00a0"==b||"\ufeff"==b},G=function(b,e){if(0<=b.indexOf(" "))for(var l=b.split(" "),k=0,n=l.length;k<n;k++)s(D,l[k],e);else s(D,b,e)},D=function(){};s(D,"dev",!1,void 0,!0);s(D,"version","1.0.0b",void 0,!0);var K=function(b,e){b&&(this.source=b);e&&(this.language=e);if(b||e)this.chain="fjs"!=this.language&&"js"!=this.language?[new v("")]:[]},n=K.prototype={},ea=function(b,e,l){return b.clone()},N=function(b){return"JavaScriptBlockComment"==
b||"JavaScriptLineComment"==b||"HTMLCommentOpen"==b||"HTMLCommentText"==b||"HTMLCommentClose"==b||"HTMLBogusCommentOpen"==b||"HTMLBogusCommentText"==b||"HTMLBogusCommentClose"==b||"CSSComment"==b},C=function(b,e){if("{"==e||"}"==e)b.braces+="{"==e?1:b.braces?-1:0;else if("("==e||")"==e)b.parentheses+="("==e?1:b.parentheses?-1:0;else if("["==e||"]"==e)b.brackets+="["==e?1:b.brackets?-1:0;else if("<"==e||">"==e)b.tags+="<"==e?1:b.tags?-1:0},T=function(b,e){if(!b)return!0;var l=b.type;return"JavaScriptPunctuator"==
l?(l=b.text(),(")"!=l||e&&("for()"==e||"if()"==e||"while()"==e||"with()"==e))&&("}"!=l||!e||"{}"!=e)&&"]"!=l&&"++"!=l&&"--"!=l):"JavaScriptReservedWord"==l?(l=b.text(),"case"==l||"delete"==l||"do"==l||"else"==l||"extends"==l||"in"==l||"instanceof"==l||"new"==l||"return"==l||"throw"==l||"typeof"==l||"void"==l||"yield"==l):"JavaScriptTemplateString"==l?"`"!=b.source.substr(b.end-1,1):!1},U=function(b){return"JavaScriptInvalidCharacter"==b||"HTMLText"==b||"HTMLEndTagText"==b},F=function(b){return"JavaScriptWhitespace"==
b||"HTMLStartTagWhitespace"==b||"HTMLEndTagWhitespace"==b||"HTMLDOCTYPEWhitespace"==b||"CSSWhitespace"==b};n.chain=null;n.expression="";n.language="fjs";n.position=0;n.source="";n.state="";n.token=null;s(n,"clone",function(){var b=new K(this.source,this.language);b.chain=this.chain?this.chain.map(ea):null;b.expression=this.expression;b.position=this.position;b.state=this.state;b.token=this.token?this.token.clone():null;return b},!0);s(n,"equals",function(b){var e=b.chain,l=this.chain;if(!(l&&l.length)!=
!(e&&e.length))return!1;if(l)for(var k=0,n=l.length;k<n;k++)if(!l[k].equals(e[k]))return!1;return!this.token!=!b.token||this.token&&!this.token.equals(b.token)?!1:this.expression===b.expression&&this.language===b.language&&this.state===b.state},!0);s(n,"next",function(){var b=this.source,e=b.length,l=this.position,k=this.token,n=this.expression,q=this.language,a=this.position,d=this.state||q,g=this.chain,r=g?g.length:0,h=r?g[r-1]:null;if(0>a||a>=e)return null;var m="",f=!1,p=!1,t=null,s="";switch(d){case "js":case "fjs":case "JavaScriptIdentifier":case "JavaScriptReservedWord":case "JavaScriptPunctuator":case "JavaScriptNumber":case "JavaScriptDoubleQuotedString":case "JavaScriptSingleQuotedString":case "JavaScriptTemplateString":case "JavaScriptRegExp":case "JavaScriptBlockComment":case "JavaScriptLineComment":case "JavaScriptInvalidCharacter":case "JavaScriptWhitespace":case "FusionStartTagOpen":case "FusionEndTagOpen":case "FusionDirectiveTagOpen":case "FusionProperty":case "FusionAttributeTemplateStringHead":case "FusionAttributeTemplateStringMiddle":case "FusionSubstitutionOpen":case "FusionObjectSubstitutionOpen":case "FusionSelectorSubstitutionOpen":case "FusionStyleSubstitutionOpen":var c=
b[a];if(y(c)||"_"==c||"$"==c||"\\"==c||"@"==c&&"fjs"==q&&k&&("JavaScriptIdentifier"==k.type||!("JavaScriptPunctuator"!=k.type&&"CSSPunctuator"!=k.type||")"!=b[k.start]&&"]"!=b[k.start]))){"\\"!=c&&a++;d="@"==c?"FusionProperty":"JavaScriptIdentifier";do if(c=b[a],!J(c)&&"_"!=c&&"$"!=c&&"\u200c"!=c&&"\u200d"!=c){if("\\"!=c)break;f=b[a+1];if("u"!=f)break;f=b[a+2];if("{"==f){for(c=0;w(b[a+c+3]);)c++;if(c&&"}"==b[a+c+3])a+=c+3;else break}else if(w(f)&&w(b[a+3])&&w(b[a+4])&&w(b[a+5]))a+=5;else break}while(++a<
e);a==l?(a++,d="JavaScriptInvalidCharacter"):k&&"JavaScriptPunctuator"==k.type&&"."==k.text()||"fjs"==q&&"FusionProperty"==d||((e=b.substring(l,a),"fjs"==q&&k&&("FusionStartTagOpen"==k.type&&("break"==e||"case"==e||"continue"==e||"default"==e||"do"==e||"else"==e||"for"==e||"if"==e||"switch"==e||"while"==e)||"FusionEndTagOpen"==k.type&&"while"==e))?(d="JavaScriptReservedWord",t=new v("FusionEndTagOpen"==k.type?"</@"+e:"<@"+e)):"null"==e||"false"==e||"true"==e||"break"==e||"case"==e||"catch"==e||"class"==
e||"const"==e||"continue"==e||"debugger"==e||"default"==e||"delete"==e||"do"==e||"else"==e||"enum"==e||"export"==e||"extends"==e||"finally"==e||"for"==e||"function"==e||"if"==e||"implements"==e||"import"==e||"in"==e||"instanceof"==e||"interface"==e||"let"==e||"new"==e||"package"==e||"private"==e||"protected"==e||"public"==e||"return"==e||"static"==e||"super"==e||"switch"==e||"this"==e||"throw"==e||"try"==e||"typeof"==e||"var"==e||"void"==e||"while"==e||"with"==e||"yield"==e?((k=k&&"JavaScriptReservedWord"==
k.type?k.text():null)&&("get"==k||"set"==k)||h&&"{"==h.state||(d="JavaScriptReservedWord"),"fjs"!=q||"else"!=k||!h||"<@else"!=h.state||"do"!=e&&"for"!=e&&"if"!=e&&"switch"!=e&&"while"!=e||(m=" "+e)):"get"!=e&&"set"!=e||!h||"{"!=h.state||(e=(f=this.peek(a))?f.type:null,"JavaScriptIdentifier"!=e&&"JavaScriptReservedWord"!=e)||(e=(f=this.peek(f.end))?f.type:null,"JavaScriptPunctuator"==e&&"("==b[f.start]&&(d="JavaScriptReservedWord",s="{:")))}else if(S(c)||B(c)){a++;d="JavaScriptWhitespace";do if(c=
b[a],!S(c)&&!B(c))break;while(++a<e)}else if('"'==c||"'"==c||"`"==c||"}"==c&&h&&0==h.braces&&I(h.state,"`${")){f="}"==c&&"=`${"==h.state;k="}"!=c?c:"`";a++;d=f?"FusionAttributeTemplateStringTail":'"'==k?"JavaScriptDoubleQuotedString":"'"==k?"JavaScriptSingleQuotedString":"JavaScriptTemplateString";"}"==c&&(m=c+k,p=!0);do if(c=b[a],"\\"==c){if(++a>=e)break;"\r"==b[a]&&"\n"==b[a+1]&&a++}else if(c==k){a++;break}else if("`"==k){if("$"==c&&"{"==b[a+1]){a+=2;t=new v(p?h.state:"`${");f&&(d="FusionAttributeTemplateStringMiddle");
break}}else if(B(c))break;while(++a<e)}else if("/"==c)if(f=b[a+1],"*"==f){a+=2;d="JavaScriptBlockComment";do if("*"==b[a]&&"/"==b[a+1]){a+=2;break}while(++a<e)}else if("/"==f)for(a+=2,d="JavaScriptLineComment";!B(b[a]);)a++;else if("fjs"==q&&">"==f&&h&&x(h.state,"<@")&&("<@break"==h.state||"<@case"==h.state||"<@continue"==h.state||"<@default"==h.state||"<@else"==h.state))a+=2,d="FusionStartTagSelfClose",m=c+f,p=!0;else if(a++,T(k,n)){d="JavaScriptRegExp";f=!1;do if(c=b[a],"\\"==c){if(++a>=e||B(b[a]))break}else if(!f&&
"/"==c){a++;break}else if(!f&&"["==c)f=!0;else if(f&&"]"==c)f=!1;else if(B(c))break;while(++a<e);if("/"==c&&(c=b[a],y(c)||"_"==c||"$"==c)){a++;do if(c=b[a],!J(c)&&"_"!=c&&"$"!=c&&"\u200c"!=c&&"\u200d"!=c)break;while(++a<e)}}else d="JavaScriptPunctuator","="==b[a]&&a++;else if(u(c)||"."==c&&u(b[a+1]))if(d="JavaScriptNumber",f="0"==c?b[a+1]:null,"0"!=c||"."==f||"e"==f||"E"==f){if("."!=c){for(a++;u(b[a]);)a++;c=b[a]}if("."==c){for(a++;u(b[a]);)a++;c=b[a]}f=b[a+1];if(("e"==c||"E"==c)&&(u(f)||("+"==f||
"-"==f)&&u(b[a+2])))for(a+="+"==f||"-"==f?3:2;u(b[a]);)a++}else{if(a++,(c="b"==f||"B"==f?ca:"o"==f||"O"==f?da:"x"==f||"X"==f?w:null)&&c(b[a+1]))for(a+=2;c(b[a]);)a++}else if("{"==c){if(a++,d="JavaScriptPunctuator",e=k&&"JavaScriptReservedWord"==k.type?k.text():null,f=k&&"JavaScriptPunctuator"==k.type?k.text():null,g){if(e&&"do"!=e&&"else"!=e&&"export"!=e&&"finally"!=e&&"import"!=e&&"try"!=e||f&&"{"!=f&&";"!=f&&"=>"!=f&&"}"!=f)if("("==f||"["==f||","==f||"?"==f||":"==f||"="==f)t=new v("{");else if(!n||
!I(n,"()"))if(e=(f=this.peek(a))?f.type:null,"JavaScriptIdentifier"==e||"JavaScriptReservedWord"==e||"JavaScriptDoubleQuotedString"==e||"JavaScriptSingleQuotedString"==e)k="JavaScriptIdentifier"==e?f.text():null,e=(f=this.peek(f.end))?f.type:null,"JavaScriptPunctuator"==e&&":"==f.text()?t=new v("{"):"get"!=k&&"set"!=k||"JavaScriptIdentifier"!=e&&"JavaScriptReservedWord"!=e||(e=(f=this.peek(f.end))?f.type:null,"JavaScriptPunctuator"==e&&"("==b[f.start]&&(t=new v("{")));h&&!t&&C(h,c)}}else if("}"==
c){if(a++,d="JavaScriptPunctuator",h){if(0==h.braces)if("fjs"==q&&I(h.state,"${"))d="<${"==h.state?"FusionSubstitutionClose":"@{:${"==h.state?"FusionObjectSubstitutionClose":"@(${"==h.state||"@[${"==h.state?"FusionSelectorSubstitutionClose":"FusionStyleSubstitutionClose",m=c,p=!0;else if("{"==h.state||"{:"==h.state)s="{}",p=!0;p||C(h,c)}}else if("("==c){a++;d="JavaScriptPunctuator";if("fjs"==q&&h&&(x(h.state,"<@")||x(h.state,"</@"))){if(e=h.state,"<@for"==e||"<@if"==e||"<@switch"==e||"<@while"==e||
"<@else for"==e||"<@else if"==e||"<@else switch"==e||"<@else while"==e||"</@while"==e)m=c}else g&&k&&"JavaScriptReservedWord"==k.type&&(k=k.text(),"catch"==k||"function"==k||"for"==k||"if"==k||"switch"==k||"while"==k||"with"==k)&&(t=new v(k+"("));h&&!t&&C(h,c)}else if(")"==c)a++,d="JavaScriptPunctuator",h&&I(h.state,"(")&&("fjs"==q&&(x(h.state,"<@")||x(h.state,"</@"))?1==h.parentheses&&(m=c):0==h.parentheses&&(m=c,p=!0)),h&&!p&&C(h,c);else if("["==c||"]"==c)a++,d="JavaScriptPunctuator",h&&C(h,c);
else if(":"==c)a++,d="JavaScriptPunctuator",h&&0==h.braces&&"{"==h.state&&(s="{:");else if(","==c)a++,d="JavaScriptPunctuator",h&&0==h.braces&&"{:"==h.state&&(s="{");else if(";"==c||"?"==c||"~"==c)a++,d="JavaScriptPunctuator";else if("="==c)c=b[++a],d="JavaScriptPunctuator","="==c?"="==b[++a]&&a++:">"==c&&a++;else if("&"==c||"|"==c||"+"==c||"-"==c)f=b[a+1],a+=c==f||"="==f?2:1,d="JavaScriptPunctuator";else if("!"==c||"*"==c||"^"==c||"%"==c)d="JavaScriptPunctuator","="==b[a+1]?(a+=2,"!"==c&&"="==b[a]&&
a++):a++;else if("<"==c||">"==c)if(f=b[a+1],c==f||"="==f)a+=2,d="JavaScriptPunctuator",c==f&&(c=b[a],">"==f&&">"==c&&(c=b[++a]),"="==c&&a++);else if(a++,d="JavaScriptPunctuator","fjs"==q)if(">"==c&&h&&(x(h.state,"<@")||x(h.state,"</@"))){if(I(h.state,"()")||"<@do"==h.state||"<@else do"==h.state)d=x(h.state,"</@")?"FusionEndTagClose":"FusionStartTagClose",m=c,p=!0}else"<"==c&&"/"==f&&"@"==b[a+1]&&h&&"<@"==h.state?(a+=2,d="FusionEndTagOpen"):">"==c&&k&&"FusionStartTagOpen"==k.type?d="FusionStartTagClose":
">"==c&&k&&"FusionEndTagOpen"==k.type?d="FusionEndTagClose":"<"==c&&y(f)&&T(k,n)&&(d="HTMLStartTagOpen",t=new v("<"),C(t,c));else"<"==c&&"/"==f&&"script"==b.substr(a+1,6)&&h&&"<script"==h.state&&(a++,d="HTMLEndTagOpen",m=">",p=!0);else"."==c?(c=b[++a],d="JavaScriptPunctuator","."==c&&"."==b[a+1]&&(a+=2)):"fjs"==q&&"@"==c?(f=b[a+1],a++,d="{"==f?"FusionObject":"("==f||"["==f?"FusionSelector":"JavaScriptInvalidCharacter",!g||"{"!=f&&"("!=f&&"["!=f||(t=new v(c+f))):(a++,d="JavaScriptInvalidCharacter");
break;case "html":case "fhtml":case "HTMLStartTagClose":case "HTMLStartTagSelfClose":case "HTMLEndTagClose":case "HTMLCharacterReference":case "HTMLCommentClose":case "HTMLBogusCommentClose":case "HTMLDOCTYPEClose":case "HTMLCDATAClose":case "FusionStartTagClose":case "FusionStartTagSelfClose":case "FusionEndTagClose":case "FusionDirectiveTagClose":case "FusionSubstitutionClose":d="HTMLText";case "HTMLText":do if(c=b[a],"<"==c)if(f=b[a+1],y(f)){if(a!=l)break;a++;d="HTMLStartTagOpen";h&&C(h,c);break}else if("/"==
f){if(a!=l)break;f=b[a+2];"fjs"==q&&"@"==f?(a+=3,d="FusionEndTagOpen"):y(f)?(a+=2,d="HTMLEndTagOpen"):(a+=2,d="HTMLBogusCommentOpen");break}else if("fjs"==q&&"@"==f){if(a!=l)break;a+=2;d="FusionStartTagOpen";break}else if("!"==f){if(a!=l)break;f=b[a+2];">"==f?(a+=2,d="HTMLBogusCommentOpen"):"fjs"==q&&"@"==f?(a+=3,d="FusionDirectiveTagOpen"):"-"==f&&"-"==b[a+3]?(a+=4,d="HTMLCommentOpen"):(f=b.substr(a+2,7),"DOCTYPE"==f?(a+=9,d="HTMLDOCTYPEOpen"):"[CDATA["==f?(a+=9,d="HTMLCDATAOpen"):(a+=2,d="HTMLBogusCommentOpen"));
break}else{if("?"==f){if(a!=l)break;a+=2;d="HTMLBogusCommentOpen";break}}else if("&"==c){c=null;f=b[a+1];if("#"==f)if(f=b[a+2],"x"==f||"X"==f){if(f=b[a+3],w(f)){if(a!=l)break;a+=4;c=w}}else{if(u(f)){if(a!=l)break;a+=3;c=u}}else if(y(f)){if(a!=l)break;a+=2;c=J}if(c){for(d="HTMLCharacterReference";c(b[a]);)a++;";"!=b[a++]&&a--;break}}else if("fjs"==q&&"$"==c&&"{"==b[a+1]&&h&&"<"==h.state){if(a!=l)break;a+=2;d="FusionSubstitutionOpen";t=new v("<${");break}while(++a<e);break;case "HTMLStartTagOpen":case "HTMLEndTagOpen":if(y(b[a])){a++;
d="HTMLStartTagOpen"!=d?"HTMLEndTagName":"HTMLStartTagName";do if(c=b[a],">"==c||"/"==c||z(c))break;while(++a<e);h&&(h.tag=b.substring(l,a));break}case "HTMLEndTagName":case "HTMLEndTagText":case "HTMLEndTagWhitespace":f="HTMLStartTagOpen"!=d;case "HTMLStartTagName":case "HTMLStartTagSolidus":case "HTMLStartTagWhitespace":case "HTMLAttributeName":case "HTMLAttributeOperator":case "HTMLAttributeValue":case "HTMLAttributeDoubleQuotedValue":case "HTMLAttributeSingleQuotedValue":case "FusionAttributeTemplateString":case "FusionAttributeTemplateStringTail":c=
b[a];if(">"==c){if(a++,d=f?"HTMLEndTagClose":"HTMLStartTagClose",h){(e=f)||(e=h.tag,e="area"==e||"base"==e||"br"==e||"col"==e||"embed"==e||"hr"==e||"img"==e||"input"==e||"keygen"==e||"link"==e||"menuitem"==e||"meta"==e||"param"==e||"source"==e||"track"==e||"wbr"==e);e&&C(h,c);if("fjs"!=q&&!f&&"script"==h.tag||"style"==h.tag)t=new v("<"+h.tag);h.tag=""}}else if(z(c))for(a++,d=f?"HTMLEndTagWhitespace":"HTMLStartTagWhitespace";z(b[a]);)a++;else if(f){a++;d="HTMLEndTagText";do if(c=b[a],">"==c||z(c))break;
while(++a<e)}else if("="==c&&k&&"HTMLAttributeName"==k.type)a++,d="HTMLAttributeOperator";else if(k&&"HTMLAttributeOperator"==k.type){k='"'==c||"'"==c||"`"==c&&"fjs"==q&&h&&"<"==h.state?c:null;a++;d="`"==k?"FusionAttributeTemplateString":'"'==k?"HTMLAttributeDoubleQuotedValue":"'"==k?"HTMLAttributeSingleQuotedValue":"HTMLAttributeValue";do if(c=b[a],k)if(c==k){a++;break}else{if("`"==k&&"$"==c&&"{"==b[a+1]){a+=2;d="FusionAttributeTemplateStringHead";t=new v("=`${");break}}else if(">"==c||z(c))break;
while(++a<e)}else if("/"==c)if(c=b[++a],d="HTMLStartTagSolidus",">"==c)a++,d="HTMLStartTagSelfClose",h&&(C(h,c),h.tag="");else for(;"/"==c;)c=b[++a];else{a++;d="HTMLAttributeName";do if(c=b[a],">"==c||"/"==c||"="==c||z(c))break;while(++a<e)}break;case "HTMLCommentOpen":d="HTMLCommentText";case "HTMLCommentText":do if(c=b[a],">"==c){if(a==l&&k&&"HTMLCommentOpen"==k.type){a++;d="HTMLCommentClose";break}}else if("-"==c)if(f=b[a+1],">"==f){if(a==l&&k&&"HTMLCommentOpen"==k.type){a+=2;d="HTMLCommentClose";
break}}else if("-"==f&&(f=b[a+2],">"==f||"!"==f&&">"==b[a+3])){if(a!=l)break;a+="!"==f?4:3;d="HTMLCommentClose";break}while(++a<e);break;case "HTMLBogusCommentOpen":d="HTMLBogusCommentText";case "HTMLBogusCommentText":do if(">"==b[a]){if(a!=l)break;a++;d="HTMLBogusCommentClose";break}while(++a<e);break;case "HTMLDOCTYPEOpen":case "HTMLDOCTYPEString":case "HTMLDOCTYPEDoubleQuotedString":case "HTMLDOCTYPESingleQuotedString":case "HTMLDOCTYPEWhitespace":c=b[a];if(">"==c)a++,d="HTMLDOCTYPEClose";else if(z(c))for(a++,
d="HTMLDOCTYPEWhitespace";z(b[a]);)a++;else{k='"'==c||"'"==c?c:null;a++;d='"'==c?"HTMLDOCTYPEDoubleQuotedString":"'"==c?"HTMLDOCTYPESingleQuotedString":"HTMLDOCTYPEString";do if(c=b[a],k){if(c==k){a++;break}}else if(">"==c||z(c))break;while(++a<e)}break;case "HTMLCDATAOpen":d="HTMLCDATAText";case "HTMLCDATAText":do if("]"==b[a]&&"]"==b[a+1]&&">"==b[a+2]){if(a!=l)break;a+=3;d="HTMLCDATAClose";break}while(++a<e);break;case "css":case "fcss":case "CSSIdentifier":case "CSSNumber":case "CSSDelimiter":case "CSSPunctuator":case "CSSDimension":case "CSSPercentage":case "CSSComma":case "CSSColon":case "CSSSemicolon":case "CSSDoubleQuotedString":case "CSSSingleQuotedString":case "CSSHash":case "CSSFunction":case "CSSAtKeyword":case "CSSMatch":case "CSSUrl":case "CSSColumn":case "CSSUnicodeRange":case "CSSComment":case "CSSWhitespace":case "FusionObject":case "FusionSelector":case "FusionObjectSubstitutionClose":case "FusionSelectorSubstitutionClose":case "FusionStyleSubstitutionClose":c=
b[a];k=u(c);k||"+"!=c&&"-"!=c&&"."!=c||(f=b[a+1],k=u(f)||"."!=c&&"."==f&&u(b[a+2]));if(k){d="CSSNumber";if("."!=c){for(a++;u(b[a]);)a++;c=b[a]}if("."==c&&u(b[a+1])){for(a+=2;u(b[a]);)a++;c=b[a]}f=b[a+1];if(("e"==c||"E"==c)&&(u(f)||("+"==f||"-"==f)&&u(b[a+2]))){for(a+="+"==f||"-"==f?3:2;u(b[a]);)a++;c=b[a]}if("%"==c){a++;d="CSSPercentage";break}else if(!y(c)&&"_"!=c&&"\\"!=c&&"-"!=c&&"\u0080">c)break}if(k||y(c)||"_"==c||"\\"==c||"#"==c||"@"==c||"-"==c||"\u0080"<=c)if(k||"u"!=c&&"U"!=c||"+"!=b[a+1]||
!w(b[a+2])&&"?"!=b[a+2]){d=k?"CSSDimension":"#"==c?"CSSHash":"@"==c?"CSSAtKeyword":"CSSIdentifier";if("\\"==c){if(B(b[a+1])){k||a++;d=k?"CSSNumber":"CSSDelimiter";break}++a<e&&a++}else if("#"==c||"@"==c||"-"==c)if(f=b[a+1],y(f)||"_"==f||"-"==f||"\\"==f&&!B(b[a+2])||!("\u0080">f)||"#"==c&&u(f))if("@"==c&&"-"==f){f=b[a+2];if(!y(f)&&"_"!=f&&"-"!=f&&("\\"!=f||B(b[a+3]))&&"\u0080">f){a++;d="CSSDelimiter";break}a+=3}else a+=2;else{k||a++;d=k?"CSSNumber":"CSSDelimiter";break}else a++;do if(c=b[a],"\\"==
c){if(B(b[a+1]))break;if(++a>=e)break}else if(!J(c)&&"_"!=c&&"-"!=c&&"\u0080">c)break;while(++a<e);if("("==c&&"CSSIdentifier"==d&&(a++,d="CSSFunction",h&&C(h,c),a==l+4&&"url"==b.substr(l,3).toLowerCase())){for(c=0;z(b[a+c]);)c++;f=b[a+c];if('"'!=f&&"'"!=f){a+=c;d="CSSUrl";do if(c=b[a],")"==c){a++;break}else if("\\"==c&&++a>=e)break;while(++a<e)}}}else{a+=2;d="CSSUnicodeRange";for(c=0;6>c&&w(b[a+c]);)c++;f=b[a+c];if("-"==f&&w(b[a+c+1]))for(a+=c+1,c=0;6>c&&w(b[a+c]);)c++;else if("?"==f)for(;6>c&&"?"==
b[a+c];)c++;a+=c}else if("/"==c&&"*"==b[a+1]){a+=2;d="CSSComment";do if("*"==b[a]&&"/"==b[a+1]){a+=2;break}while(++a<e)}else if(z(c))for(a++,d="CSSWhitespace";z(b[a]);)a++;else if('"'==c||"'"==c){k=c;a++;d='"'==k?"CSSDoubleQuotedString":"CSSSingleQuotedString";do if(c=b[a],"\\"==c){if(++a>=e)break;"\r"==b[a]&&"\n"==b[a+1]&&a++}else if(c==k){a++;break}else if(B(c))break;while(++a<e)}else if("$"==c||"*"==c||"^"==c||"|"==c||"~"==c)f=b[a+1],"fjs"!=q||"$"!=c||"{"!=f||!h||"@{:"!=h.state&&"@("!=h.state&&
"@["!=h.state&&"<style"!=h.state?"|"==c&&"|"==f?(a+=2,d="CSSColumn"):"="==f?(a+=2,d="CSSMatch"):(a++,d="CSSDelimiter"):(a+=2,d="@{:"==h.state?"FusionObjectSubstitutionOpen":"@("==h.state||"@["==h.state?"FusionSelectorSubstitutionOpen":"FusionStyleSubstitutionOpen",t=new v(h.state+c+f));else if("("==c||")"==c||"["==c||"]"==c||"{"==c||"}"==c)a++,d="CSSPunctuator",h&&C(h,c);else if(","==c)a++,d="CSSComma";else if(":"==c)a++,d="CSSColon",h&&"@{"==h.state&&(m=c);else if(";"==c)a++,d="CSSSemicolon",h&&
"@{:"==h.state&&(s="@{");else if("<"==c)if(c=b[++a],d="CSSDelimiter","!"==c&&"-"==b[a+1]&&"-"==b[a+2]&&h&&"<style"==h.state){a+=3;d="CSSComment";do if("-"==b[a]&&"-"==b[a+1]&&">"==b[a+2]){a+=3;break}while(++a<e)}else"/"==c&&"style"==b.substr(a+1,5)&&h&&"<style"==h.state&&(a++,d="HTMLEndTagOpen",m=">",p=!0);else a++,d="CSSDelimiter";break;default:return null}this.position=a;this.state=d;"fjs"==q&&h&&"<"==h.state&&0==h.tags?(m=">",p=!0,this.state=q):"fjs"==q&&h&&(("@{"==h.state||"@{:"==h.state)&&0==
h.braces||"@("==h.state&&0==h.parentheses||"@["==h.state&&0==h.brackets)?(p=!0,s="@("==h.state?"@()":"@["==h.state?"@[]":"@{}",this.state=q):t&&"HTMLStartTagClose"==d&&("<script"==t.state?this.state="js":"<style"==t.state&&(this.state="css"));h&&(s&&(h.state=s),m&&(h.state+=m));g&&(t?p&&r?g[r-1]=t:g.push(t):p&&g.pop());if(a==l)return null;k=new P(d,b,l,a);F(d)||N(d)||(this.expression=h&&p?h.state:"",this.token=k);return k},!0);s(n,"peek",function(b,e){var l=new K;l.language=this.language;l.position=
b||this.position;l.source=this.source;l.state=e||this.state;for(var k=l.next();k;){var n=k.type;if(!F(n)&&!N(n))break;k=l.next()}return k},!0);s(n,"reset",function(){this.chain="fjs"!=this.language&&"js"!=this.language?[new v("")]:[];this.expression="";this.position=0;this.state="";this.token=null},!0);(function(){}.prototype={}).lexer=null;var v=function(b){this.state=b},n=v.prototype={};n.braces=0;n.brackets=0;n.parentheses=0;n.state="";n.tag="";n.tags=0;s(n,"clone",function(){var b=new v(this.state);
b.braces=this.braces;b.brackets=this.brackets;b.parentheses=this.parentheses;b.state=this.state;b.tag=this.tag;b.tags=this.tags;return b},!0);s(n,"equals",function(b){return this.braces===b.braces&&this.brackets===b.brackets&&this.parentheses===b.parentheses&&this.state===b.state&&this.tag===b.tag&&this.tags===b.tags},!0);var P=function(b,e,l,k){this.type=b;this.source=e;this.start=l;this.end=k},n=P.prototype={};n.end=0;n.source="";n.start=0;n.type="";s(n,"clone",function(){return new P(this.type,
this.source,this.start,this.end)},!0);s(n,"equals",function(b){return this.type===b.type&&this.text()===b.text()},!0);s(n,"html",function(){var b=this.text().replace(aa,ba);return!this.type||F(this.type)||U(this.type)?b:'<span class="fusion_'+this.type+'">'+b+"</span>"},!0);s(n,"node",function(){if(!this.type||F(this.type)||U(this.type))return document.createTextNode(this.text());var b=document.createElement("span");this.type&&b.setAttribute("class","fusion_"+this.type);b.innerText=this.text();return b},
!0);s(n,"text",function(){return this.source.substring(this.start,this.end)},!0);G("highlight",function(b,e){for(var l=new K(b,e),k="",n=null,q=null,a=null;q=l.next();)if(x(q.type,"CSS")){null==a&&(a=[]);n&&(x(n.type,"CSS")||"FusionObjectSubstitutionClose"==n.type||"FusionSelectorSubstitutionClose"==n.type||"FusionStyleSubstitutionClose"==n.type)||a.unshift("*");var d=q.type;if(F(d))k+=q.html();else{var g=a[0],r=null,h="CSSPunctuator"==d?q.text():null;if("{"==h)"*"!=g&&"@"!=g?(g="*{",a.unshift(g)):
a[0]+=h;else if("}"==h)"*{"==g||"*{:"==g?1<a.length?a.shift():a[0]="*":"@{"!=g&&"@{:"!=g||a.shift();else if("CSSSemicolon"==d)if("@"==g)a.shift();else{if("*{:"==g||"@{:"==g)a[0]=g[0]+"{"}else if("CSSColon"!=d||"*{"!=g&&"@{"!=g){if("CSSAtKeyword"!=d||"*"!=g&&"*{"!=g&&"@{"!=g||(g="@",a.unshift(g)),h="@{"==g&&"CSSIdentifier"==d?l.peek(q.end):null,r="*{"==g&&"CSSIdentifier"==d||h&&"CSSColon"==h.type?"CSSDeclarationName":"*{:"==g||"@{:"==g?"CSSDeclarationValue":"*"==g||"@{"==g?"CSSSelector":"@"==g?"CSSAtRule":
null,"*{:"==g||"@{:"==g)"CSSDelimiter"==d&&"!"==q.text()?(h=l.peek(q.end))&&"CSSIdentifier"==h.type&&"important"==h.text().toLowerCase()&&(h=l.peek(h.end))&&("CSSSemicolon"==h.type||"CSSPunctuator"==h.type&&"}"==h.text())&&(r="CSSDeclarationImportant"):n&&"CSSDelimiter"==n.type&&"!"==n.text()&&"CSSIdentifier"==d&&"important"==q.text().toLowerCase()&&(h=l.peek(q.end))&&("CSSSemicolon"==h.type||"CSSPunctuator"==h.type&&"}"==h.text())&&(r="CSSDeclarationImportant")}else a[0]+=":";r?(n=q.clone(),n.type=
r,k+=n.html()):k+=q.html();n=l.token}}else k+=q.html(),n=l.token;return k});G("transpile",function(b,e,l,k,n,q){b=new K(b,"fjs");for(var a="",d=null,g=null,r=[],h=function(a,b){return b.toUpperCase()};d=b.next();){if("FusionSelector"==d.type||"FusionSelectorSubstitutionClose"==d.type){for(var m="",f="FusionSelector"==d.type,p=!0;d=b.next();)if("FusionSelectorSubstitutionOpen"==d.type)g=b.peek(),g&&"JavaScriptPunctuator"==g.type&&"}"==g.text()||(m+='"+(',p=!1),g=b.token;else if("FusionSelectorSubstitutionClose"==
d.type)g&&"FusionSelectorSubstitutionOpen"==g.type||(m+=')+"',p=!0),g=b.token;else{if(!x(d.type,"CSS"))break;N(d.type)||(m+=d.text().replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n\\\n"),g=b.token)}var s=/^\(\s*(head|html|body)\s*\)$/i.exec(m);s?(m=s[1].toLowerCase(),a+="document."+("html"==m?"documentElement":m)):(a+=f?"["==m[0]?(k||"document.__query")+'("':(l||"document.__find")+'("':')+"',a+=m.substr(f?1:0,m.length-(f&&p?2:1)),p&&(a+='")'))}else if("FusionObject"==d.type||"FusionObjectSubstitutionClose"==
d.type)for(m="FusionObject"!=d.type,!m||g&&"FusionObjectSubstitutionOpen"==g.type||(a+=')+"');d=b.next();)if("FusionObjectSubstitutionOpen"==d.type)g&&"CSSColon"==g.type&&(a+='"'),(g=b.peek())&&"JavaScriptPunctuator"==g.type&&"}"==g.text()||(a+='"+('),g=b.token;else if("FusionObjectSubstitutionClose"==d.type)g&&"FusionObjectSubstitutionOpen"==g.type||(a+=')+"'),g=b.token;else{if(!x(d.type,"CSS"))break;if(!N(d.type)){if(f=F(d.type)?d:null)if(d=b.next(),!d){a+=f.text();break}if(m){if("CSSPunctuator"==
d.type&&"}"==d.text()&&"fjs"==b.state){g&&"CSSSemicolon"==g.type||(a+='"');f&&(a+=f.text());a+=d.text();g=b.token;continue}else if("CSSSemicolon"==d.type){a+='"';m=!1;f&&(a+=f.text());g=b.token;continue}else f&&(a+=f.text().replace(/\n/g,"\\n\\\n"));"FusionObjectSubstitutionOpen"==d.type?(g=b.peek())&&"JavaScriptPunctuator"==g.type&&"}"==g.text()||(a+='"+('):"FusionObjectSubstitutionClose"==d.type?g&&"FusionObjectSubstitutionOpen"==g.type||(a+=')+"'):a+=d.text().replace(/\\/g,"\\\\").replace(/"/g,
'\\"')}else"CSSIdentifier"==d.type&&g&&("CSSPunctuator"==g.type&&"{"==g.text()||"CSSSemicolon"==g.type)?("CSSSemicolon"==g.type&&(a+=","),f&&(a+=f.text()),a+='"',a+=d.text().replace(/^-+/,"").replace(/-+([a-z])/ig,h),a+='"'):"CSSColon"==d.type?(f&&(a+=f.text()),a+=d.text()):"CSSSemicolon"==d.type?f&&(a+=f.text()):g&&"CSSColon"==g.type?(f&&(a+=f.text()),m=!0,"fjs"!=b.state&&(a+='"'),"FusionObjectSubstitutionOpen"==d.type?(g=b.peek())&&"JavaScriptPunctuator"==g.type&&"}"==g.text()||(a+='"+('):"FusionObjectSubstitutionClose"==
d.type?g&&"FusionObjectSubstitutionOpen"==g.type||(a+=')+"'):a+=d.text().replace(/\\/g,"\\\\").replace(/"/g,'\\"')):(f&&(a+=f.text()),a+=d.text());g=b.token}}if(!d)break;if("FusionProperty"==d.type)a+=".__"+d.text().substr(1);else if("FusionSubstitutionOpen"==d.type||"FusionStyleSubstitutionOpen"==d.type)a+='"+(';else if("FusionSubstitutionClose"==d.type||"FusionStyleSubstitutionClose"==d.type)a+=')+"';else if("HTMLStartTagOpen"==d.type)r.length&&(a+=d.text());else if("HTMLStartTagName"==d.type)m=
d.text(),r.push(m),m=m.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),a+=1<r.length?m:(e||"document.__create")+'("'+m+'")';else if(r.length)if("HTMLStartTagClose"==d.type)!g||"HTMLAttributeName"!=g.type&&"HTMLAttributeOperator"!=g.type?!g||"JavaScriptTemplateString"!=g.type&&"FusionAttributeTemplateString"!=g.type&&"FusionAttributeTemplateStringTail"!=g.type||(a+=")"):a+='"")',m=r[r.length-1],"area"==m||"base"==m||"br"==m||"col"==m||"embed"==m||"hr"==m||"img"==m||"input"==m||"keygen"==m||"link"==m||"menuitem"==
m||"meta"==m||"param"==m||"source"==m||"track"==m||"wbr"==m?(r.pop(),r.length&&(a+=d.text())):a+=1<r.length?d.text():"."+(q||"__html")+'("';else if("HTMLEndTagOpen"==d.type)a+=1<r.length?d.text():'")';else if("HTMLEndTagName"==d.type){m=d.text();if(m!=r[r.length-1])throw"unmatched <"+r[r.length-1]+"> tag";1<r.length&&(a+=m.replace(/\\/g,"\\\\").replace(/"/g,'\\"'))}else if("HTMLStartTagSelfClose"==d.type||"HTMLEndTagClose"==d.type||"HTMLEndTagSelfClose"==d.type)"HTMLStartTagSelfClose"==d.type&&g&&
"HTMLAttributeName"==g.type?a+='"")':"HTMLStartTagSelfClose"!=d.type||!g||"JavaScriptTemplateString"!=g.type&&"FusionAttributeTemplateString"!=g.type&&"FusionAttributeTemplateStringTail"!=g.type||(a+=")"),r.pop(),r.length&&(a+=d.text());else if(1==r.length&&"HTMLAttributeName"==d.type)g&&"HTMLAttributeName"==g.type?a+='"")':!g||"JavaScriptTemplateString"!=g.type&&"FusionAttributeTemplateString"!=g.type&&"FusionAttributeTemplateStringTail"!=g.type||(a+=")"),a+="."+(n||"__attr")+'("',a+=d.text().replace(/\\/g,
"\\\\").replace(/"/g,'\\"'),a+='",';else if(1==r.length&&("HTMLAttributeValue"==d.type||"HTMLAttributeDoubleQuotedValue"==d.type||"HTMLAttributeSingleQuotedValue"==d.type)){m=d.text();"HTMLAttributeValue"!=d.type&&(m=m.substr(1,m.length-2));a+='"';d=0;for(f=m.length;d<f;){p=m[d];if("&"==p)if(g=m[d+1],"#"==g)if(g=m[d+2],"x"==g||"X"==g){if(g=m[d+3],w(g)){d+=3;g="";do{p=m[d];if(!w(p))break;g+=p}while(++d<f);for(";"!=m[d++]&&d--;4>g.length;)g="0"+g;a+="\\u";a+=g;continue}}else{if("0"<=g&&"9">=g){d+=2;
g="";do{p=m[d];if("0">p||"9"<p)break;g+=p}while(++d<f);";"!=m[d++]&&d--;for(g=Z(g,10).toString(16);4>g.length;)g="0"+g;a+="\\u";a+=g;continue}}else{if(y(g)){d++;g="&";do{p=m[d];if(!J(p))break;g+=p}while(++d<f);";"!=m[d++]?d--:g+=";";p=M[g.substr(1)];R(p)?p="\\u"+O(p[0],4,"0")+"\\u"+O(p[1],4,"0"):p&&(p="\\u"+O(p,4,"0"));a+=p?p:g;continue}}else if('"'==p){a+='\\"';d++;continue}else if("\n"==p){a+="\\n\\\n";d++;continue}else if("\\"==p){a+="\\\\";d++;continue}a+=p;d++}a+='")'}else if(1==r.length&&"HTMLStartTagSolidus"==
d.type)g&&"HTMLAttributeName"==g.type?a+='"")':!g||"JavaScriptTemplateString"!=g.type&&"FusionAttributeTemplateString"!=g.type&&"FusionAttributeTemplateStringTail"!=g.type||(a+=")");else if("FusionAttributeTemplateString"==d.type||"FusionAttributeTemplateStringHead"==d.type||"FusionAttributeTemplateStringMiddle"==d.type||"FusionAttributeTemplateStringTail"==d.type){m=d.text();d="`"==m[0];f="`"==m[m.length-1];if(d)a+='"';else if(!g||"FusionAttributeTemplateStringHead"!=g.type&&"FusionAttributeTemplateStringMiddle"!=
g.type||"`"==g.source[g.end-1])a+=')+"';a+=m.substr(1,f?m.length-2:m.length-3).replace(/"/g,'\\"').replace(/\n/g,"\\n\\\n");f?a+='"':(g=b.peek())&&"JavaScriptPunctuator"==g.type&&"}"==g.text()||(a+='"+(')}else if("HTMLText"==d.type||x(d.type,"CSS"))a+=d.text().replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n\\\n");else if("HTMLStartTagWhitespace"==d.type)a+=g&&"HTMLAttributeOperator"==g.type?d.text():d.text().replace(/^[^\r\n]+/,"");else{if(1<r.length||"HTMLEndTagText"!=d.type&&"HTMLEndTagSolidus"!=
d.type&&"HTMLAttributeOperator"!=d.type)a+=d.text()}else"JavaScriptTemplateString"==d.type?(m=d.text(),d="`"==m[0],f="`"==m[m.length-1],d?a+='"':g&&"JavaScriptTemplateString"==g.type&&"`"!=g.source[g.end-1]||(a+=')+"'),a+=m.substr(1,f?m.length-2:m.length-3).replace(/"/g,'\\"').replace(/\n/g,"\\n\\\n"),f?a+='"':(g=b.peek())&&"JavaScriptPunctuator"==g.type&&"}"==g.text()||(a+='"+(')):a+=d.text();g=b.token}if(r.length)throw"unmatched <"+r[r.length-1]+"> tag";return a});"function"==typeof define&&define.amd?
define(function(){return D}):"undefined"!=typeof module&&null!=module&&module.exports?module.exports=D:function(b){var e=E.f_Shorthand,l=E.f_Writable;"string"!=typeof e&&(e=!0===e?"f":"");"boolean"!=typeof l&&(l="undefined"!=typeof E.intellisense);!b||Y.call(b,"fusion")&&!l||(e&&s(b,e,D,l),s(b,"fusion",D,l))}(H.window===H?H:E)})(this);